<ng-template #addIcon>
    <igx-icon family="default" name="add"></igx-icon>
</ng-template>

<ng-template #closeIcon>
    <igx-icon family="default" name="close"></igx-icon>
</ng-template>

<ng-template #selectFromTemplate>
    <div class="igx-filter-tree__inputs" [style.display]="(isInEditMode() && !this.isAdvancedFiltering()) ? 'flex' : 'none'">
        <div>
            <span>From</span>
            <igx-select #entitySelect
                type="box"
                (selectionChanging)="onEntitySelectChanging($event)"
                (opening)="exitEditAddMode(true)"
                [overlaySettings]="entitySelectOverlaySettings"
                [ngModel]="selectedEntity"
                [style.display]="isInEditMode() ? 'block' : 'none'"
                [placeholder]="this.resourceStrings.igx_query_builder_select_entity"
            >
                <igx-select-item *ngFor="let entity of entities" [value]="entity">
                    {{entity.name}}
                </igx-select-item>
            </igx-select>
        </div>

        <div>
            <span>Select</span>
            @if(!parentExpression) {
                <igx-combo
                    #returnFieldsCombo
                    [itemsMaxHeight]="250"
                    [data]="fields"
                    [displayKey]="'field'"
                    [valueKey]="'field'"
                    [disabled]="!selectedEntity"
                    [(ngModel)]="selectedReturnFields"
                    [overlaySettings]="returnFieldSelectOverlaySettings"
                    [placeholder]="this.resourceStrings.igx_query_builder_select_return_fields"
                    searchPlaceholder="{{ this.resourceStrings.igx_query_builder_search }}"
                    [style.display]="isInEditMode() ? 'block' : 'none'"
                    (selectionChanging)="onReturnFieldSelectChanging($event)"
                    (opening)="exitEditAddMode()"
                >
                    <ng-template igxComboHeader>
                        <div
                            class="igx-drop-down__item igx-drop-down__item--query-builder"
                            (click)="onSelectAllClicked($event)"                
                            [ngClass]="{'igx-drop-down__item--selected': this.selectedEntity && this.selectedReturnFields && this.selectedEntity.fields.length === this.selectedReturnFields.length}"
                        >
                            <igx-checkbox
                                    [checked]="this.selectedEntity && this.selectedReturnFields && this.selectedEntity.fields.length === this.selectedReturnFields.length"
                                    [indeterminate]="this.selectedEntity && this.selectedReturnFields && this.selectedReturnFields.length > 0 && this.selectedReturnFields.length < this.selectedEntity.fields?.length"
                                    [readonly]="true"
                                    [disableRipple]="true"
                                    [tabindex]="-1"
                                    class="igx-combo__checkbox">
                            </igx-checkbox>
                            <div class="igx-drop-down__inner">
                                {{ this.resourceStrings.igx_query_builder_select_all }}
                            </div>
                        </div>
                    </ng-template>
                </igx-combo>
            }
            @else {
                <igx-select #returnFieldSelect
                    type="box"
                    (selectionChanging)="onReturnFieldSelectChanging($event)"
                    [overlaySettings]="returnFieldSelectOverlaySettings"
                    [disabled]="!selectedEntity"
                    [ngModel]="selectedReturnFields[0]"
                    [placeholder]="this.resourceStrings.igx_query_builder_select_return_field_single"
                    [style.display]="isInEditMode() ? 'block' : 'none'"
                    (opening)="exitEditAddMode()"
                >
                    <igx-select-item *ngFor="let field of fields" [value]="field.field">
                        {{ field.field }}
                    </igx-select-item>
                </igx-select>
            }
        </div>
    </div>
</ng-template>

<div
    #expressionsContainer
    class="igx-query-builder__main"
    style="display: grid;"
>
    <ng-container *ngTemplateOutlet="selectFromTemplate"></ng-container>

    <ng-template #addExpressionsTemplate let-expressionItem let-afterExpression="afterExpression">
        <button type="button"
            #addConditionButton
            igxButton="outlined"
            [disabled]="hasEditedExpression"
            (click)="addCondition(expressionItem, afterExpression)"
            igxDrop 
            (enter)="onAddConditionEnter(addConditionButton, expressionItem)"
            (leave)="onChipLeave()"
        >
            <ng-container *ngTemplateOutlet="addIcon"></ng-container>
            <span>{{
                this.resourceStrings.igx_query_builder_add_condition_root
            }}</span>
        </button>

        @if(this.rootGroup) {
            <button type="button"
                igxButton="outlined"
                [disabled]="hasEditedExpression"
                (click)="addReverseGroup(expressionItem, afterExpression)"
            >
                <ng-container *ngTemplateOutlet="addIcon"></ng-container>
                <span>{{ this.resourceStrings.igx_query_builder_add_group_root }}</span>
            </button>
        }
    </ng-template>

    <ng-template #operandTemplate let-expressionItem>
        <div
            #dragRef 
            igxDrop
            (enter)="onChipEnter(dragRef, expressionItem, true)"
            (over)="onDivOver(dragRef, expressionItem)"
            (leave)="onChipLeave()"
            (dropped)="onDivDropped(expressionItem)"
            *ngIf="!expressionItem.inEditMode"
            class="igx-filter-tree__expression-item"            
            (mouseenter)="expressionItem.hovered = true"
            (mouseleave)="expressionItem.hovered = false"
            (focusin)="onExpressionFocus(expressionItem)"
            (focusout)="onExpressionBlur($event, expressionItem)"
        >
            <igx-chip        
                [draggable]="canBeDragged() ? 'true' : 'false'" 
                [hideBaseOnDrag] = "false"    
                [animateOnRelease] = "false"
                (moveStart)="canBeDragged() ? onMoveStart(dragRef, expressionItem, false, true): null" 
                (moveEnd)="onMoveEnd()"
                (dragEnter)="onChipEnter(dragRef, expressionItem, false)"
                (dragOver)="onChipOver(dragRef, false)"
                (dragLeave)="onChipLeave()"
                (dragDrop)="onChipDropped()"
                #target="tooltipTarget"
                [igxTooltipTarget]="tooltipRef"
                [data]="expressionItem"
                [removable]="isInEditMode() ? 'true' : 'false'"
                (keydown)="invokeClick($event)"
                (click)="onChipClick(expressionItem)"
                (remove)="onChipRemove(expressionItem)"                
                
            >
                <igx-icon igxPrefix 
                    class="igx-drag-indicator"
                    tabindex="0"
                    (focus)="onChipDragIndicatorFocus(dragRef, expressionItem)" 
                    (focusout)="onChipDragIndicatorFocusOut()"    
                >
                    drag_indicator
                </igx-icon>
                <span igxPrefix class="igx-filter-tree__expression-column">
                    {{expressionItem.fieldLabel || expressionItem.expression.fieldName}}
                </span>
                <span igxPrefix class="igx-filter-tree__expression-condition">
                    {{
                        getConditionFriendlyName(
                            expressionItem.expression.condition?.name
                        )
                    }}
                </span>
                <span *ngIf="!expressionItem.expression.condition?.isUnary">
                    <ng-container *ngIf="expressionItem.expression.searchTree">
                        <strong>{{expressionItem.expression.searchTree.entity}}</strong>&nbsp;/ {{formatReturnFields(expressionItem.expression.searchTree)}}
                    </ng-container>

                    <ng-container *ngIf="!expressionItem.expression.searchTree">
                        @if(isDate(expressionItem.expression.searchVal)) {
                            @if(getFormatter(expressionItem.expression.fieldName)) {
                               {{
                                    expressionItem.expression.searchVal
                                    | fieldFormatter
                                        : getFormatter(
                                                expressionItem.expression.fieldName
                                            )
                                        : undefined
                               }}
                            } @else {
                                {{
                                    expressionItem.expression.searchVal
                                    | date
                                        : getFormat(
                                                expressionItem.expression.fieldName
                                            )
                                        : undefined
                                        : this.locale
                                }}
                            }
                        } @else {
                            @if(getFormatter(expressionItem.expression.fieldName)) {
                                {{
                                    expressionItem.expression.searchVal
                                        | fieldFormatter
                                        : getFormatter(expressionItem.expression.fieldName)
                                        : (expressionItem.expression.conditionName ||  expressionItem.expression.condition?.name)
                                }}
                            } @else {
                                {{ expressionItem.expression.searchVal }}
                            }
                        }
                    </ng-container>
                </span>
            </igx-chip>
            <div #tooltipRef="tooltip" igxTooltip>
                @if(expressionItem.expression.searchTree){
                    {{expressionItem.expression.searchTree.returnFields.join(', ')}}
                } @else if (expressionItem.expression.condition?.isUnary) {
                    {{getConditionFriendlyName(expressionItem.expression.condition?.name)}}
                } @else {
                    @if(getFormatter(expressionItem.expression.fieldName)) {
                        {{
                            expressionItem.expression.searchVal
                                | fieldFormatter
                                : getFormatter(expressionItem.expression.fieldName)
                                : (expressionItem.expression.conditionName || expressionItem.expression.condition?.name)
                        }}
                    } @else {
                        {{ expressionItem.expression.searchVal }}
                    }
                }
            </div>

            @if((expressionItem.focused || expressionItem.hovered) && !expressionItem.inAddMode) {
                <div igxDragIgnore class="igx-filter-tree__expression-actions">
                    <button #addExpressionButton igxDragIgnore igxIconButton="flat" [igxDropDownItemNavigation]="addOptionsDropDown"
                    aria-labelledby="add-expression" (keydown)="invokeClick($event)"
                        (click)="clickExpressionAdd(addExpressionButton)"
                        (blur)="addExpressionBlur()">
                        <igx-icon id="add-expression">add</igx-icon>
                    </button>
                    <igx-drop-down #addOptionsDropDown
                        (selectionChanging)="enterExpressionAdd($event, expressionItem)">
                        <igx-drop-down-item [value]="'addCondition'">
                            <span>{{this.resourceStrings.igx_query_builder_add_condition}}</span>
                        </igx-drop-down-item>
                        <igx-drop-down-item [value]="'addGroup'">
                            <span>{{this.resourceStrings.igx_query_builder_add_group}}</span>
                        </igx-drop-down-item>
                    </igx-drop-down>
                </div>
            }
        </div>

        <div
            #editingInputsContainer
            igxDrop
            (enter)="onChipEnter(editingInputsContainer, expressionItem, true)"
            (over)="onDivOver(editingInputsContainer, expressionItem)"
            (leave)="onChipLeave()"
            (dropped)="onDivDropped(expressionItem)"
            *ngIf="expressionItem.inEditMode"
            class="igx-filter-tree__inputs"
        >
            <igx-select
                #fieldSelect
                type="box"
                [overlaySettings]="fieldSelectOverlaySettings"
                [(ngModel)]="selectedField"
                [disabled]="!fields"
            >
                <label igxLabel>{{this.resourceStrings.igx_query_builder_column_placeholder}}</label>
                <igx-select-item *ngFor="let field of fields" [value]="field">
                    {{ field.label || field.header || field.field }}
                </igx-select-item>
            </igx-select>

            <igx-select
                #conditionSelect
                type="box"
                [overlaySettings]="conditionSelectOverlaySettings"
                [(ngModel)]="selectedCondition"
                [disabled]="!selectedField"
                [placeholder]="this.resourceStrings.igx_query_builder_condition_placeholder"
            >
                <igx-prefix
                    *ngIf="
                        selectedField &&
                        conditionSelect.value &&
                        selectedField.filters.condition(conditionSelect.value)
                    "
                >
                    <igx-icon
                        family="default"
                        [name]="
                            selectedField.filters.condition(
                                conditionSelect.value
                            ).iconName
                        "
                    >
                    </igx-icon>
                </igx-prefix>

                <igx-select-item
                    *ngFor="let condition of getConditionList()"
                    [value]="condition"
                    [text]="getConditionFriendlyName(condition)"
                >
                    <div class="igx-grid__filtering-dropdown-items">
                        <igx-icon
                            family="default"
                            [name]="
                                selectedField.filters.condition(condition)
                                    .iconName
                            "
                        >
                        </igx-icon>
                        <span class="igx-grid__filtering-dropdown-text">{{
                            getConditionFriendlyName(condition)
                        }}</span>
                    </div>
                </igx-select-item>
            </igx-select>

            <ng-container
                *ngTemplateOutlet="
                    searchValueTemplate ? searchValueTemplate : defaultSearchValueTemplate;
                    context: getSearchValueTemplateContext(defaultSearchValueTemplate)
                "
            >
            </ng-container>

            <ng-template #defaultSearchValueTemplate>
                <igx-input-group
                    *ngIf="
                        !selectedField ||
                        (selectedField.dataType !== 'date' &&
                            selectedField.dataType !== 'time' &&
                            selectedField.dataType !== 'dateTime')
                    "
                    type="box"
                >
                    <label igxLabel>{{this.resourceStrings.igx_query_builder_value_placeholder}}</label>
                    <input
                        #searchValueInput
                        igxInput
                        [disabled]="isSearchValueInputDisabled()"
                        [type]="
                            selectedField && selectedField.dataType === 'number'
                                ? 'number'
                                : 'text'
                        "
                        [(ngModel)]="searchValue.value"
                    />
                </igx-input-group>

                <igx-date-picker
                    #picker
                    *ngIf="selectedField && selectedField.dataType === 'date'"
                    [(value)]="searchValue.value"
                    (keydown)="openPicker($event)"
                    (click)="picker.open()"
                    type="box"
                    [readOnly]="true"
                    [disabled]="isSearchValueInputDisabled()"
                    [locale]="this.locale"
                    [outlet]="pickerOutlet"
                    [formatter]="selectedField.formatter"
                    [displayFormat]="selectedField.pipeArgs.format"
                    [weekStart]="selectedField.pipeArgs.weekStart"
                >
                    <label igxLabel>{{this.resourceStrings.igx_query_builder_date_placeholder}}</label>
                    <!-- disable default icons -->
                    <igx-picker-toggle></igx-picker-toggle>
                    <igx-picker-clear></igx-picker-clear>
                </igx-date-picker>

                <igx-time-picker
                    #picker
                    *ngIf="selectedField && selectedField.dataType === 'time'"
                    [(value)]="searchValue.value"
                    (click)="picker.open()"
                    (keydown)="openPicker($event)"
                    type="box"
                    [readOnly]="true"
                    [disabled]="isSearchValueInputDisabled()"
                    [locale]="this.locale"
                    [outlet]="pickerOutlet"
                    [formatter]="selectedField.formatter"
                    [displayFormat]="selectedField.pipeArgs.format"
                    [inputFormat]="selectedField.editorOptions?.dateTimeFormat"
                >
                    <!-- disable default icons -->
                    <label igxLabel>{{this.resourceStrings.igx_query_builder_time_placeholder}}</label>
                    <igx-picker-toggle></igx-picker-toggle>
                    <igx-picker-clear></igx-picker-clear>
                </igx-time-picker>

                <igx-input-group
                    #inputGroup
                    type="box"
                    *ngIf="selectedField && selectedField.dataType === 'dateTime'"
                    type="box"
                >
                    <label igxLabel>{{this.resourceStrings.igx_query_builder_datetime_placeholder}}</label>
                    <input
                        #input
                        igxInput
                        tabindex="0"
                        [(ngModel)]="searchValue.value"
                        [disabled]="isSearchValueInputDisabled()"
                        [locale]="this.locale"
                        [igxDateTimeEditor]="selectedField.editorOptions?.dateTimeFormat"
                        [defaultFormatType]="selectedField.dataType"
                        [displayFormat]="selectedField.pipeArgs.format"
                    />
                </igx-input-group>
            </ng-template>

            <div class="igx-filter-tree__inputs-actions">
                <button type="button"
                    igxIconButton="flat"
                    [disabled]="!operandCanBeCommitted()"
                    (click)="commitOperandEdit()"
                >
                    <igx-icon family="default" name="confirm"></igx-icon>
                </button>
                <button type="button"
                    igxIconButton="flat"
                    (click)="cancelOperandEdit()"
                >
                    <ng-container *ngTemplateOutlet="closeIcon"></ng-container>
                </button>
            </div>
        </div>

        <ng-container *ngIf="
            (!expressionItem.inEditMode && expressionItem.expression.searchTree && expressionItem.expression.searchTree.filteringOperands?.length > 0) ||
            (expressionItem.inEditMode && selectedField?.filters?.condition(selectedCondition)?.isNestedQuery)">
            <igx-query-builder-tree
                [style.display]="expressionItem.inEditMode || expressionItem.expanded ? 'block' : 'none'"
                [entities]="entities"
                [queryBuilder]="this.queryBuilder"
                [parentExpression]="expressionItem"
                [expressionTree]="expressionItem.inEditMode ? (innerQueryNewExpressionTree ?? getExpressionTreeCopy(expressionItem.expression.searchTree, true)) : expressionItem.expression.searchTree"
                (inEditModeChange)="onInEditModeChanged($event)"
                [searchValueTemplate]="searchValueTemplate">
            </igx-query-builder-tree>
        </ng-container>
    </ng-template>

    <ng-template #expressionGroupTemplate let-expressionItem>
        <div class="igx-filter-tree"
            (focusout)="parentExpression? null : onDragFocusOut()">
            <div
                class="igx-filter-tree__line"
                [ngClass]="{
                    'igx-filter-tree__line--and': getOperator(expressionItem) === 0,
                    'igx-filter-tree__line--or': getOperator(expressionItem) === 1
                }"
            ></div>

            <div class="igx-filter-tree__expression">
                <div style="width: 100%;"
                    class="igx-filter-tree-group-context-menu"
                    #groupRef 
                    igxDrop
                    (enter)="onGroupRootOver(groupRef, expressionItem)"
                    (over)="onGroupRootOver(groupRef, expressionItem)"
                    (leave)="onChipLeave()"
                >
                    <button #changeGroupButton
                            [igxDropDownItemNavigation]="groupContextMenuDropDown"
                            igxDragIgnore
                            igxButton="flat"
                            aria-labelledby="change-group"
                            (keydown)="invokeClick($event)"
                            (click)="onGroupClick(groupContextMenuDropDown, changeGroupButton, expressionItem)"
                    >
                        <span 
                            igxDrop
                            (enter)="onGroupRootOver(groupRef, expressionItem)"
                            (over)="onGroupRootOver(groupRef, expressionItem)"
                            (leave)="onChipLeave()"
                        > 
                            {{getOperator(expressionItem) === 0 ? this.resourceStrings.igx_query_builder_and_label : this.resourceStrings.igx_query_builder_or_label}}
                        </span>
                        <igx-icon family="default" name="arrow_drop_down" role="button"></igx-icon>
                    </button>
                    <igx-drop-down #groupContextMenuDropDown
                                   (selectionChanging)="onGroupContextMenuDropDownSelectionChanging($event)"
                                   [width]="'fit-content'">
                        <igx-drop-down-item [value]="'switchCondition'"
                        >
                            {{getSwitchGroupText(expressionItem)}}
                        </igx-drop-down-item>
                        <igx-drop-down-item [value]="'ungroup'"
                                            [disabled]="this.rootGroup === this.contextualGroup"
                        >
                            {{this.resourceStrings.igx_query_builder_ungroup}}
                        </igx-drop-down-item>
                    </igx-drop-down>
                </div>
                <ng-container *ngFor="let expr of expressionItem?.children">
                    <ng-container
                        *ngTemplateOutlet="
                            isExpressionGroup(expr)
                                ? expressionGroupTemplate
                                : operandTemplate;
                            context: context(expr)
                        "
                    >
                    </ng-container>
                </ng-container>
                <div
                    *ngIf="expressionItem === rootGroup"
                    #currentGroupButtonsContainer
                    class="igx-filter-tree__buttons"
                >
                    <ng-container
                        *ngTemplateOutlet="
                            addExpressionsTemplate;
                            context: context(expressionItem)
                        "
                    >
                    </ng-container>
                </div>
            </div>
        </div>
    </ng-template>

    <ng-container *ngIf="rootGroup || (!rootGroup && (selectedEntity || (entities?.length === 1 && !entities[0]?.name)))">
        <span>Where</span>
        <ng-container
            *ngTemplateOutlet="
                expressionGroupTemplate;
                context: context(rootGroup)
            "
        ></ng-container>
    </ng-container>
</div>

<div
    #overlayOutlet
    igxOverlayOutlet
    class="igx-query-builder__outlet"
    (pointerdown)="onOutletPointerDown($event)"
></div>

<igx-dialog
    #entityChangeDialog
    title="{{ this.resourceStrings.igx_query_builder_dialog_title }}"
    leftButtonLabel="{{ this.resourceStrings.igx_query_builder_dialog_cancel }}"
    rightButtonLabel="{{ this.resourceStrings.igx_query_builder_dialog_confirm }}"
    (leftButtonSelect)="onEntityChangeCancel()"
    (rightButtonSelect)="onEntityChangeConfirm()">
    <section class="igx-query-builder-dialog">
        <p>{{ this.resourceStrings.igx_query_builder_dialog_message }}</p>
        <igx-checkbox
                (change)="onShowEntityChangeDialogChange($event)"
                [disableRipple]="true"
                [tabindex]="-1">
            {{ this.resourceStrings.igx_query_builder_dialog_checkbox_text }}
        </igx-checkbox>
    </section>
</igx-dialog>
